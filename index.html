<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Checklist Camion - PDF Avanzato</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:18px; color:#222; }
h1 { text-align:center; margin-bottom:14px; }
#layout { display:flex; gap:18px; flex-wrap:wrap; }
#left { flex:1; background:#fff; padding:14px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
#right { flex:1; min-width:300px; position:relative; }
svg { width:100%; height:auto; display:block; border:1px solid #ccc; border-radius:6px; }
.compartimento { border:1px solid #ddd; margin:8px 0; border-radius:6px; overflow:hidden; }
.compartimento h3 { margin:0; padding:10px; background:#eee; cursor:pointer; }
.checklist { padding:10px; display:none; }
.checklist-item { display:flex; justify-content:space-between; align-items:center; margin:6px 0; padding:6px; border-radius:4px; }
.checklist-item.presente { background:#4CAF50; color:#fff; }
.checklist-item.assente { background:#f44336; color:#fff; }
label { margin-right:10px; cursor:pointer; }
#exportPDF { margin-top:10px; padding:8px 12px; cursor:pointer; background:#2196F3; color:#fff; border:none; border-radius:4px; font-weight:600; }

/* Bottoni visibili ma senza testo */
.hotspot-btn { 
  position:absolute; 
  background:rgba(33,150,243,0.25);
  border:3px solid #2196F3;
  border-radius:6px; 
  cursor:pointer; 
}
.blinking { 
  animation: blink 1s infinite; 
  border-color:#1976D2 !important; 
}
@keyframes blink { 
  0%,100% {opacity:1;} 
  50% {opacity:0.4;} 
}

/* Finestra di scelta per il PDF */
#pdfModal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none; align-items: center; justify-content: center;
}
#pdfModalContent {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 350px;
  width: 100%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
#pdfModalContent h3 { margin-top: 0; }
#pdfModalContent label { display:block; margin:6px 0; }
#pdfModalContent input[type="text"] { width: 100%; padding:6px; margin-top:8px; margin-bottom:12px; }
#pdfModalContent button { padding:8px 12px; margin-right:8px; cursor:pointer; border:none; border-radius:4px; }
#confirmPDF { background:#2196F3; color:#fff; font-weight:600; }
#cancelPDF { background:#ccc; }
</style>
</head>
<body>

<h1>Checklist Camion â€” PDF Avanzato</h1>

<div id="layout">
  <div id="left">
    <h2>Checklist</h2>
    <div id="camion"></div>
    <button id="exportPDF">Esporta PDF</button>
  </div>
  <div id="right">
    <svg id="camionSVG" viewBox="0 0 600 800">
      <image href="https://davide1499.github.io/prova-5/camion.jpg" x="0" y="0" width="600" height="400"/>
      <image href="https://davide1499.github.io/prova-5/ciao.jpg" x="0" y="400" width="600" height="400"/>
      <path id="Cabina" d="M360,120 C370,115 468,115 468,120 L468,220 C468,225 370,225 360,220 Z" fill="rgba(0,0,0,0.1)"/>
      <path id="Anteriore Destro" d="M252,136 C260,130 348,130 348,136 L348,280 C348,285 260,285 252,280 Z" fill="rgba(0,0,0,0.1)"/>
      <path id="Centrale Destro" d="M164,136 C170,132 246,132 246,136 L246,236 C246,240 170,240 164,236 Z" fill="rgba(0,0,0,0.1)"/>
      <path id="Posteriore Destro" d="M75,136 C80,132 160,132 160,136 L160,272 C160,278 80,278 75,272 Z" fill="rgba(0,0,0,0.1)"/>
    </svg>
  </div>
</div>

<!-- Modale per esportazione PDF -->
<div id="pdfModal">
  <div id="pdfModalContent">
    <h3>Esporta PDF</h3>
    <label><input type="radio" name="pdfChoice" value="tutta" checked> Tutta la checklist</label>
    <label><input type="radio" name="pdfChoice" value="manca"> Solo elementi mancanti</label>
    <input type="text" id="pdfFilename" placeholder="Nome file (senza estensione)" value="checklist_camion">
    <div>
      <button id="confirmPDF">Esporta</button>
      <button id="cancelPDF">Annulla</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const camionData = {
  "Cabina": ["Autoradio","Paletta Segnaletica","Nastro Segnaletico"],
  "Anteriore Destro": ["Pompa sommersa","Gruppo elettrogeno"],
  "Centrale Destro": ["3 Manichette alta pressione","7 Manichette UNI 45"],
  "Posteriore Destro": ["Premiscelatore di linea","Divisore 70/45"]
};

function createCamionUI(){
  const camionDiv=document.getElementById("camion");
  camionDiv.innerHTML="";
  Object.keys(camionData).forEach(comp=>{
    const div=document.createElement("div");
    div.className="compartimento";
    const title=document.createElement("h3");
    title.textContent=comp;
    div.appendChild(title);

    const checklistDiv=document.createElement("div");
    checklistDiv.className="checklist";

    camionData[comp].forEach(item=>{
      const row=document.createElement("div");
      row.className="checklist-item";

      const label=document.createElement("span");
      label.textContent=item;

      const presLabel=document.createElement("label");
      presLabel.textContent="Presente ";
      const pres=document.createElement("input");
      pres.type="checkbox";
      presLabel.prepend(pres);

      const assLabel=document.createElement("label");
      assLabel.textContent="Assente ";
      const ass=document.createElement("input");
      ass.type="checkbox";
      assLabel.prepend(ass);

      pres.addEventListener('change', ()=>{
        if(pres.checked) ass.checked=false;
        row.classList.toggle('presente', pres.checked);
        row.classList.remove('assente');
      });
      ass.addEventListener('change', ()=>{
        if(ass.checked) pres.checked=false;
        row.classList.toggle('assente', ass.checked);
        row.classList.remove('presente');
      });

      const chkGroup=document.createElement("div");
      chkGroup.appendChild(presLabel);
      chkGroup.appendChild(assLabel);

      row.appendChild(label);
      row.appendChild(chkGroup);
      checklistDiv.appendChild(row);
    });

    div.appendChild(checklistDiv);
    camionDiv.appendChild(div);
  });
}

function createHotspotButtons(){
  const svg=document.getElementById("camionSVG");
  const rightDiv=document.getElementById("right");
  Object.keys(camionData).forEach(comp=>{
    const path=svg.getElementById(comp);
    const btn=document.createElement("button");
    btn.className="hotspot-btn";
    btn.textContent=""; 
    btn.dataset.path = comp;
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.checklist').forEach(c=>c.style.display='none');
      const header=Array.from(document.querySelectorAll('.compartimento h3')).find(h=>h.textContent===comp);
      if(header) header.nextElementSibling.style.display='block';
      document.querySelectorAll('.hotspot-btn').forEach(b=>b.classList.remove('blinking'));
      btn.classList.add('blinking');
    });
    rightDiv.appendChild(btn);
    btn._targetPath = path;
  });
  updateHotspotPositions();
  window.addEventListener('resize', updateHotspotPositions);
}

function updateHotspotPositions(){
  const svg=document.getElementById("camionSVG");
  const svgRect=svg.getBoundingClientRect();
  const scaleX=svgRect.width / svg.viewBox.baseVal.width;
  const scaleY=svgRect.height / svg.viewBox.baseVal.height;
  document.querySelectorAll('.hotspot-btn').forEach(btn=>{
    const bbox = btn._targetPath.getBBox();
    btn.style.left = `${bbox.x * scaleX}px`;
    btn.style.top  = `${bbox.y * scaleY}px`;
    btn.style.width = `${bbox.width * scaleX}px`;
    btn.style.height = `${bbox.height * scaleY}px`;
  });
}

createCamionUI();
createHotspotButtons();

// Modale per PDF
const modal = document.getElementById('pdfModal');
document.getElementById('exportPDF').addEventListener('click', ()=> modal.style.display="flex");
document.getElementById('cancelPDF').addEventListener('click', ()=> modal.style.display="none");

document.getElementById('confirmPDF').addEventListener('click', ()=>{
  const scelta = document.querySelector('input[name="pdfChoice"]:checked').value;
  let filename = document.getElementById('pdfFilename').value.trim();
  if(!filename) filename = "checklist_camion";

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  let yOffset = 20;

  Object.keys(camionData).forEach(comp=>{
    doc.setFontSize(12);
    doc.text(comp, 40, yOffset);
    yOffset += 20;

    const compartimentoDiv = Array.from(document.querySelectorAll('.compartimento h3'))
      .find(h=>h.textContent===comp).nextElementSibling;

    const rows = compartimentoDiv.querySelectorAll('.checklist-item');
    rows.forEach(row=>{
      const text = row.firstChild.textContent;
      const stato = row.classList.contains('presente') ? "Presente" : row.classList.contains('assente') ? "Assente" : "";

      if(scelta === 'manca' && stato !== "Assente") return;

      doc.text(`${text}: ${stato}`, 60, yOffset);
      yOffset += 16;
      if(yOffset > 780){ doc.addPage(); yOffset=20; }
    });
    yOffset += 10;
  });

  doc.save(`${filename}.pdf`);
  modal.style.display="none";
});
</script>

</body>
</html>