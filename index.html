<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Checklist Aps</title>
<style>
  /* Evidenziazione permanente dall'input di ricerca */
.focus-selected {
  outline: 3px solid #2196F3;
  background-color: rgba(33,150,243,0.2);
  border-radius: 6px;
  transition: background-color 1s, outline 1s; 
}

.fade-out { background-color: transparent !important; outline: 0 !important; }

body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:18px; color:#222; }
h1 { text-align:center; margin-bottom:14px; }
#layout { display:flex; gap:18px; flex-wrap:wrap; }
#left { flex:1; background:#fff; padding:14px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
#right { flex:1; min-width:300px; position:relative; }
svg { width:100%; height:auto; display:block; border:1px solid #ccc; border-radius:6px; }

.compartimento { border:1px solid #ddd; margin:8px 0; border-radius:6px; overflow:hidden; }
.compartimento h3 { margin:0; padding:10px; background:#eee; cursor:pointer; transition: background 0.3s; }
.subcategory { margin-left:20px; border-left:2px dashed #aaa; padding-left:10px; margin-top:6px; }
.subcategory h4 { margin-left: 0; }
.checklist { padding:10px; display:none; }
.checklist-item { display:flex; justify-content:space-between; align-items:center; margin:6px 0; padding:6px; border-radius:4px; }
.checklist-item.presente { background:#4CAF50; color:#fff; }
.checklist-item.assente { background:#f44336; color:#fff; }
label { margin-right:10px; cursor:pointer; }
#exportPDF, #schedaTecnica { margin-top:10px; padding:8px 12px; cursor:pointer; color:#fff; border:none; border-radius:4px; font-weight:600; }
#exportPDF { background:#2196F3; }
#schedaTecnica { background:#FF9800; }

/* Bottoni fissi */
.hotspot-btn { 
  position:absolute; 
  background:rgba(33,150,243,0.25);
  border:3px solid #2196F3;
  border-radius:6px; 
  cursor:pointer; 
  font-size:14px;
  text-align:center;
  line-height:1.2em;
  transform: translate(-50%, -50%);
}
.blinking { 
  animation: blink 1s infinite; 
  border-color:#1976D2 !important; 
}
@keyframes blink { 
  0%,100% {opacity:1;} 
  50% {opacity:0.4;} 
}

/* Lampeggio dolce per la checklist con sfumatura finale */
@keyframes focusBlink {
  0%   { background-color: transparent; }
  25%  { background-color: rgba(33,150,243,0.25); }
 50%  { background-color: rgba(33,150,243,0.25); }
  75%  { background-color: rgba(33,150,243,0.15); }
  100% { background-color: transparent; }
}
.focus-blink {
  animation: focusBlink 1s ease-in-out 1;
}

/* Animazione sottocategorie */
.subcategory div {
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.4s ease;
}
.subcategory.open div {
  max-height: 1000px;
}

/* Compartimento completato */
.compartimento h3.completed {
  background: #4CAF50;
  color: #fff;
}
.hotspot-btn.completed {
  background: rgba(76, 175, 80, 0.25) !important;
  border-color: #4CAF50 !important;
}

/* Modale scheda tecnica */
#modalScheda { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000; }
#modalSchedaContent { background:#fff; border-radius:8px; max-width:800px; width:90%; max-height:90%; overflow:auto; padding:20px; position:relative; display:flex; flex-direction:column; gap:15px; }
#modalSchedaContent img { width:100%; border-radius:6px; max-height:400px; object-fit:contain; }
#closeModal { position:absolute; top:10px; right:10px; background:#f44336; color:#fff; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-weight:bold; }
#prevSlide, #nextSlide { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:#fff; border:none; font-size:24px; padding:6px 12px; cursor:pointer; }
#prevSlide { left:0; }
#nextSlide { right:0; }
</style>
</head>

<body>

<h1>Checklist Eurocity</h1>

<div id="layout">
  <div id="left">
    <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:20px; width:100%;">
      <div style="display:flex; flex-direction:column; gap:10px; width:100%; max-width:320px;">
        <div style="display:flex; gap:10px; width:100%;">
          <button id="exportPDF" style="flex:1; padding:10px; font-size:16px;">Esporta PDF</button>
          <button id="schedaTecnica" style="flex:1; padding:10px; font-size:16px;">Scheda Tecnica</button>
        </div>
        <div style="position:relative; width:100%;">
          <input type="text" id="searchInput" placeholder="Cerca elemento..." style="width:100%; padding:8px 10px; border-radius:6px; border:2px solid #2196F3; font-size:14px;">
          <ul id="searchSuggestions" style="position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #2196F3; border-radius:6px; max-height:150px; overflow:auto; list-style:none; margin:0; padding:0; display:none; z-index:10;"></ul>
        </div>
      </div>
    </div>

    <div id="camion"></div>
  </div>

  <div id="right">
    <svg id="camionSVG" viewBox="0 0 600 2000">
      <image href="https://davide1499.github.io/prova-5/camion.jpg" x="0" y="0" width="600" height="400"/>
      <rect x="0" y="0" width="600" height="30" fill="#fff"/>
      <text x="300" y="22" text-anchor="middle" font-size="20" font-weight="bold" fill="#000">Anteriore Destro</text>
        
      <image href="https://davide1499.github.io/prova-5/ciao.jpg" x="0" y="400" width="600" height="400"/>
      <rect x="0" y="400" width="600" height="30" fill="#fff"/>
      <text x="300" y="422" text-anchor="middle" font-size="20" font-weight="bold" fill="#000">Anteriore Sinistro</text>
        
      <image href="https://davide1499.github.io/prova-5/vanopompa.jpg" x="0" y="800" width="600" height="400"/>
      <rect x="0" y="800" width="600" height="30" fill="#fff"/>
      <text x="300" y="822" text-anchor="middle" font-size="20" font-weight="bold" fill="#000">Vano Pompa</text>

      <image href="https://davide1499.github.io/prova-5/cabina.jpg" x="0" y="1200" width="600" height="400"/>
      <rect x="0" y="1200" width="600" height="30" fill="#fff"/>
      <text x="300" y="1222" text-anchor="middle" font-size="20" font-weight="bold" fill="#000">Cabina</text>

      <image href="https://davide1499.github.io/prova-5/vanopompa.jpg" x="0" y="1600" width="600" height="400"/>
      <rect x="0" y="1600" width="600" height="30" fill="#fff"/>
      <text x="300" y="1622" text-anchor="middle" font-size="20" font-weight="bold" fill="#000">Tetto</text>
    </svg>
  </div>


<div id="modalScheda" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;">
  <div id="modalSchedaContent" style="background:#fff; border-radius:8px; max-width:800px; width:90%; max-height:90%; overflow:auto; padding:20px; position:relative; display:flex; flex-direction:column; gap:15px;">
    <button id="closeModal" style="position:absolute; top:10px; right:10px; background:#f44336; color:#fff; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-weight:bold;">X</button>
    <h2 style="text-align:center;">IVECO EUROCITY</h2>
    <div style="position:relative; text-align:center;">
      <img id="slideImage" src="https://davide1499.github.io/prova-5/camion.jpg" alt="Camion VVF"/>
      <button id="prevSlide">‚ùÆ</button>
      <button id="nextSlide">‚ùØ</button>
    </div>
    <h3>Modello</h3>
    <p>IVECO eurocity, anno 2000, cilindrata 5.860 cc, 207 CV</p>
    <h3>Dimensioni</h3>
    <ul><li>Lunghezza: 7,5 m</li><li>Larghezza: 2,5 m</li><li>Altezza: 3,2 m</li></ul>
    <h3>Equipaggiamento</h3>
    <ul><li>Pompa da 1200 l/min</li><li>Serbatoio acqua 1600 L</li></ul>
  </div>
</div>

<div id="modalFoto" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;">
  <div style="position:relative; background:#fff; padding:10px; border-radius:6px; max-width:90%; max-height:90%;">
    <button id="closeFoto" style="position:absolute; top:5px; right:5px; font-size:16px;">X</button>
    <img id="fotoGrande" src="https://via.placeholder.com/600x400?text=Seleziona+foto" style="max-width:100%; max-height:80vh; display:block; margin:0 auto;">
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  
  
  
const camionData = {

  "Cabina": [
    { label: "Autoradio", foto: "https://davide1499.github.io/prova-5/radio.jpg" },
    { label: "Paletta Segnaletica",},
   { "label": "Nastro Segnaletico" },
    { "label": "Confezione di guanti in lattice" },
    { "label": "Fanalino Portatile" },
    { "label": "Cerca fughe" },
    { "label": "Rilevatore Multigas" },
    { "label": "Massa grassa x fuga di gas" },
    { "label": "Chiave per ascensore" },
    { "label": "Tifor con leva" },
    { "label": "2 Tute complete x calabroni" },
    { "label": "Spray x calabroni" },
    { "label": "Segaccio" },
    { "label": "Piccone" },
    { "label": "Ascia grande" }
  ],
  "Anteriore Destro": [
    { label: "Pompa sommersa",  },
    { label: "Gruppo elettrogeno", },
    { label: "4 Tubi aspirazione",  },
    { label: "3 Piedi", },
    { label: "2 Fanalino portatile",  },
    { label: "Cesoia dielettrica" },
    { label: "Guanti dielettrici" },
    { label: "Messa a terra con cavo" },
    { label: "Valvola di fondo" }
  ],
  "Centrale Destro": {
    items: [
      { label: "3 Manichette alta pressione" },
      { label: "7 Manichette UNI 45" },
      { label: "Faro + prese elettriche" },
      { label: "Prolunga elettrica" },
      { label: "Trapano" },
      { label: "Dischi x flex" },
      { label: "Cavetti x batteria" }
    ],
    subcategories: {
      "Cassetta Attrezzi": [
        { label: "12 Chiavi fisse 6-22 mm" },
        { label: "Molettina" },
        { label: "2 Dischi x molettina" },
        { label: "7 Giraviti italiani" },
        { label: "5 Giraviti a croce" },
        { "label": "Pinza" },
        { "label": "Tenaglia" },
        { "label": "Mazzetta" },
        { "label": "Martello" }
      ]
    }
  },
  "Posteriore Destro": [
    { label: "Premiscelatore di linea" },
    { label: "Divisore 70/45" },
    { label: "Doppia femmina 70" },
    { label: "Doppio maschio 70" },
    { label: "Doppia femmina 45" },
    { label: "Doppio maschio 45" },
    { label: "Riduttore 70/45" },
    { label: "Diffusore 70/70" },
    { label: "Chiave stringi tubi" },
    { label: "Lancia americana da 45" },
    { label: "2 Lance da 70" },
    { label: "2 Lance da 45" },
    { label: "Tanica di schiumogeno" },
    { label: "2 Tubi pesca schiumogeno" }
  ],
  "Anteriore Sinistro": [
    { label: "Motosega Echo", foto:"https://davide1499.github.io/prova-5/motosega.jpg" },
    { label: "Mototroncatore Echo", foto:"https://davide1499.github.io/prova-5/mototroncatore.jpg" },
    { label: "Estintore a polvere Kg 6",},
    { label: "Estintore CO2 Kg 5" },
    { label: "Seghetto" },
    { label: "Tanica Metallo" },
    { label: "2 Cuscini di sollevamento" },
    { label: "Badile", foto: "https://davide1499.github.io/prova-5/badile.jpg"},
    { label: "Cesoia x Metallo" },
    { label: "2 Calzatoie" },
    { label: "Olio Miscela" },
    { label: "Olio Catena" },
    { label: "Cavo x il Tifor" },
    { label: "Airbag Shield" },
    { label: "Seghetto per vetro" },
    { label: "Mazza" }
  ],
"Centrale Sinistro": {
  items: [
    { label: "3 Birilli segnaletici" },
    { label: "Braga da 2 T" },
    { label: "5 Maniglioni" },
    { label: "4 Bombole" },
    { label: "6 Manichette UNI 70" },
    { label: "Disco x flex" },
    { label: "Coppia di catene" },
    { label: "Giratubi" }
  ],
  subcategories: {
    "Sacco TPSS": [
      { label: "Bombolino Ossigeno da 3L" },
      { label: "Canule di guedel" },
      { label: "Collare Cervicale" }
    ]
  }
},

  
  "Posteriore Sinistro": [
    { label: "2 Scappelli" },
    { label: "Divaricatore" },
    { label: "Cesoia" },
    { label: "Puntello idraulico" },
    { label: "Centralina barellabile" },
    { label: "Motoventilatore" },
{ "label": "Chiave a brugola" },
    { "label": "Chiave candela" }
  ],
  "Vano Pompa": [
    { label: "2 Scappelli" },
    { label: "Divaricatore" },
    { label: "Cesoia" },
    { label: "Puntello idraulico" },
    { label: "Centralina barellabile" },
    { label: "Motoventilatore" }
  ],
  "Tetto": [
    { "label": "Lancia x schiuma bassa esp." },
    { "label": "Scala italiana" },
    { "label": "3 Autoprotettori" },
    { "label": "Scala a ganci" },
    { "label": "Bombola" },
    { "label": "Mezzo marinaio" },
    { "label": "3 Maschere x autoprotettore" },
    { "label": "Forcone" },
    { "label": "Fioretto dielettrico" }
  ]
};


// --- Creazione UI checklist ---
function createCamionUI(){
  const camionDiv=document.getElementById("camion");
  camionDiv.innerHTML="";
  Object.keys(camionData).forEach(comp=>{
    const div=document.createElement("div");
    div.className="compartimento";
    const title=document.createElement("h3");
    title.textContent=comp;
    div.appendChild(title);

    const checklistDiv=document.createElement("div");
    checklistDiv.className="checklist";

    let items = [];
    let subcategories = {};

    if(Array.isArray(camionData[comp])){
      items = camionData[comp];
    } else {
      items = camionData[comp].items;
      subcategories = camionData[comp].subcategories || {};
    }

    items.forEach(item=>{
      checklistDiv.appendChild(createChecklistRow(item, comp));
    });

Object.keys(subcategories).forEach(sub => {
    const subDiv = document.createElement("div");
    subDiv.className = "subcategory";

    const subTitle = document.createElement("h4");
    subTitle.style.cursor = "pointer";
    subTitle.style.display = "flex";
    subTitle.style.alignItems = "center";
    subTitle.style.gap = "6px";

    // Pulsanti Presente / Assente
    const presenteBtn = document.createElement("button");
    presenteBtn.textContent = "Presente";
    presenteBtn.style.padding = "2px 6px";
    subTitle.appendChild(presenteBtn);

    const assenteBtn = document.createElement("button");
    assenteBtn.textContent = "Assente";
    assenteBtn.style.padding = "2px 6px";
    subTitle.appendChild(assenteBtn);

    const arrow = document.createElement("span");
    arrow.textContent = "‚ñ∂";
    arrow.style.transition = "transform 0.3s";
    arrow.style.marginLeft = "auto";
    subTitle.appendChild(arrow);

    const titleText = document.createElement("span");
    titleText.textContent = sub;
    titleText.style.marginLeft = "6px";
    subTitle.appendChild(titleText);

    subDiv.appendChild(subTitle);

    const subChecklist = document.createElement("div");
    subChecklist.style.pointerEvents = "none";
    subChecklist.style.opacity = "0.5";

    subcategories[sub].forEach(subItem => {
        const row = createChecklistRow(subItem, comp);
        row.querySelectorAll("input").forEach(i => i.disabled = true);
        subChecklist.appendChild(row);
    });
    subDiv.appendChild(subChecklist);

    // Funzione per aprire/chiudere sottocategoria
    const toggleSubcategory = (forceOpen) => {
        const isOpen = subDiv.classList.contains("open");
        const shouldOpen = forceOpen !== undefined ? forceOpen : !isOpen;
        if (shouldOpen) {
            subDiv.classList.add("open");
            arrow.style.transform = "rotate(90deg)";
        } else {
            subDiv.classList.remove("open");
            arrow.style.transform = "rotate(0deg)";
        }
    };

    // Click freccia o titolo
    arrow.addEventListener("click", (e) => {
        e.stopPropagation();
        if (presenteBtn.style.background === "rgb(76, 175, 80)") {
            toggleSubcategory();
        }
    });
    titleText.addEventListener("click", () => {
        if (presenteBtn.style.background === "rgb(76, 175, 80)") {
            toggleSubcategory();
        }
    });

  // Click Presente
presenteBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    presenteBtn.style.background = "#4caf50";
    assenteBtn.style.background = "";

    subChecklist.style.pointerEvents = "auto";
    subChecklist.style.opacity = "1";
    subChecklist.querySelectorAll("input").forEach(i => {
        i.checked = false;
        i.disabled = false;
        const row = i.closest(".checklist-item");
        if (row) row.classList.remove("presente", "assente");
    });

    // Apri sottocategoria come se cliccassi freccia
    toggleSubcategory(true);

    // Aggiorna stato compartimento
    updateCompartmentStatus(comp);
});


 // Click su Assente
assenteBtn.addEventListener("click", (e) => {
    e.stopPropagation();

    // Aggiorna colori dei bottoni
    assenteBtn.style.background = "#f44336"; // rosso
    presenteBtn.style.background = "";      // reset

    // Disabilita interazione con la sottochecklist
    subChecklist.style.pointerEvents = "none";
    subChecklist.style.opacity = "0.5";

    // Segna tutti gli item come assenti
    subChecklist.querySelectorAll(".checklist-item").forEach(item => {
        const checkbox = item.querySelector("input[type=checkbox]");
        if (checkbox) {
            checkbox.checked = false;               // deseleziona
            checkbox.disabled = true;              // disabilita
        }
        item.classList.remove("presente");         // rimuove classe presente
        item.classList.add("assente");             // aggiunge classe assente
    });

    // Chiudi sottocategoria come se cliccassi sulla freccia
    toggleSubcategory(false);

    // Aggiorna stato del compartimento
    updateCompartmentStatus(comp);
});



    // Controllo chiusura automatica se tutte le checkbox interne selezionate
    subChecklist.querySelectorAll("input").forEach(i => {
        i.addEventListener("change", () => {
            const allChecked = Array.from(subChecklist.querySelectorAll("input"))
                .every(input => input.checked);
            if(allChecked) toggleSubcategory(false); // chiude con effetto freccia
        });
    });

    checklistDiv.appendChild(subDiv);
});

div.appendChild(checklistDiv);
camionDiv.appendChild(div);


  });
}
  
function createChecklistRow(itemData, compName, title) {
  const row = document.createElement("div");
  row.className = "checklist-item";
  row.style.display = "flex";
  row.style.alignItems = "center";
  row.style.gap = "6px";
  row.style.position = "relative";

  // --- Label e foto ---
  let labelText = typeof itemData === "string" ? itemData : itemData.label;
  let fotoLink  = typeof itemData === "object" && itemData.foto ? itemData.foto : null;

  const label = document.createElement("span");
  label.textContent = labelText;
  label.className = "item-label";
  label.style.flex = "1";

  const fotoContainer = document.createElement("div");
  fotoContainer.style.width = "24px";
  fotoContainer.style.display = "flex";
  fotoContainer.style.justifyContent = "center";
  fotoContainer.style.alignItems = "center";

  if (fotoLink) {
    const fotoIcon = document.createElement("span");
    fotoIcon.textContent = "üì∑";
    fotoIcon.style.cursor = "pointer";
    fotoIcon.title = "Visualizza foto";
    fotoIcon.style.fontSize = "16px";
    fotoIcon.addEventListener("click", () => {
      document.getElementById("fotoGrande").src = fotoLink;
      document.getElementById("modalFoto").style.display = "flex";
    });
    fotoContainer.appendChild(fotoIcon);
  }

  // --- Checkbox ---
  const pres = document.createElement("input"); pres.type="checkbox";
  const ass = document.createElement("input"); ass.type="checkbox";

  pres.addEventListener('change', () => {
    if(pres.checked) ass.checked=false;
    row.classList.toggle('presente', pres.checked);
    row.classList.remove('assente');
    updateCompartmentStatus(compName);
  });

  ass.addEventListener('change', () => {
    if(ass.checked) pres.checked=false;
    row.classList.toggle('assente', ass.checked);
    row.classList.remove('presente');
    updateCompartmentStatus(compName);
  });

  const chkGroup = document.createElement("div");
  chkGroup.style.display="flex";
  chkGroup.style.gap="10px";

  const presContainer = document.createElement("div");
  presContainer.style.display="flex";
  presContainer.style.flexDirection="column";
  presContainer.style.alignItems="center";
  const presSymbol = document.createElement("span");
  presSymbol.textContent = "‚úÖ"; presSymbol.style.color="green"; presSymbol.style.fontSize="16px";
  presContainer.appendChild(presSymbol); presContainer.appendChild(pres);

  const assContainer = document.createElement("div");
  assContainer.style.display="flex";
  assContainer.style.flexDirection="column";
  assContainer.style.alignItems="center";
  const assSymbol = document.createElement("span");
  assSymbol.textContent = "‚ùå"; assSymbol.style.color="red"; assSymbol.style.fontSize="16px";
  assContainer.appendChild(assSymbol); assContainer.appendChild(ass);

  chkGroup.appendChild(presContainer);
  chkGroup.appendChild(assContainer);

  // --- Note ---
  const noteContainer = document.createElement("div");
  noteContainer.style.position = "relative";
  noteContainer.style.display = "flex";
  noteContainer.style.alignItems = "center";

  const noteIconWrapper = document.createElement("div");
  noteIconWrapper.style.display = "flex";
  noteIconWrapper.style.alignItems = "center";
  noteIconWrapper.style.justifyContent = "center";
  noteIconWrapper.style.width = "24px";
  noteIconWrapper.style.height = "24px";
  noteIconWrapper.style.border = "2px solid transparent"; 
  noteIconWrapper.style.borderRadius = "4px";
  noteIconWrapper.style.transition = "border 0.2s";

  const noteIcon = document.createElement("span");
  noteIcon.textContent = "üìù";
  noteIcon.style.cursor = "pointer";
  noteIcon.style.fontSize = "16px";
  noteIconWrapper.appendChild(noteIcon);

  const noteInput = document.createElement("textarea");
  noteInput.placeholder = "Scrivi qui le note...";
  noteInput.rows = 2;
noteInput.style.position = "fixed";
noteInput.style.top = "50%";
noteInput.style.left = "50%";
noteInput.style.transform = "translate(-50%, -50%)";
noteInput.style.width = "300px";
noteInput.style.height = "150px";
noteInput.style.resize = "none";
noteInput.style.display = "none";
noteInput.style.zIndex = "10000";
noteInput.style.background = "#fff";
noteInput.style.border = "2px solid #2196F3";
noteInput.style.borderRadius = "8px";
noteInput.style.padding = "8px";
noteInput.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";


noteIconWrapper.addEventListener("click", (e) => {
    // Rimuove eventuali evidenziazioni precedenti
    document.querySelectorAll(".checklist-item.focus-selected")
            .forEach(el => el.classList.remove("focus-selected"));

    noteInput.style.display = noteInput.style.display === "none" ? "block" : "none";
    if(noteInput.style.display === "block") noteInput.focus();
    e.stopPropagation();
});


  document.addEventListener("click", (e) => {
    if (!noteContainer.contains(e.target)) {
      noteInput.style.display = "none";
    }
  });

  noteInput.addEventListener("input", () => {
    const hasNote = noteInput.value.trim() !== "";
    noteIconWrapper.style.border = hasNote ? "2px solid #FF9800" : "2px solid transparent";

    if (title) {
      let mainBadge = title.querySelector(".note-badge");
      const allNotes = title.closest(".compartimento").querySelectorAll(".checklist-item textarea");
      const anyNote = Array.from(allNotes).some(t => t.value.trim() !== "");
      if (anyNote && !mainBadge) {
        mainBadge = document.createElement("span");
        mainBadge.className = "note-badge";
        mainBadge.textContent = "üìù";
        mainBadge.style.marginLeft = "6px";
        mainBadge.style.color = "#FF9800";
        title.appendChild(mainBadge);
      } else if (!anyNote && mainBadge) {
        mainBadge.remove();
      }
    }
  });

  noteContainer.appendChild(noteIconWrapper);
  noteContainer.appendChild(noteInput);

  // --- Composizione riga ---
  row.appendChild(fotoContainer);
  row.appendChild(label);
  row.appendChild(chkGroup);
  row.appendChild(noteContainer);

  return row;
}





// --- Bottoni hotspot ---
function createHotspotButtons() {
  const rightDiv = document.getElementById("right");
  const svg = document.getElementById("camionSVG");

  const hotspots = [
      {name:"Cabina", x:300, y:1340, width:180, height:73},
      {name:"Anteriore Destro", x:301.5, y:210, width:104, height:146},
      {name:"Centrale Destro", x:205, y:187, width:79, height:100},
      {name:"Posteriore Destro", x:116.2, y:205, width:83.5, height:135},
      {name:"Anteriore Sinistro", x:298, y:610, width:95, height:146},
      {name:"Centrale Sinistro", x:389.5, y:587, width:77,height:100},
      {name:"Posteriore Sinistro", x:475.8, y:605, width:83, height:137},
      {name:"Vano Pompa", x:301, y:1000, width:110, height:163},
      {name:"Tetto", x:300, y:1800, width:110, height:163}
  ];

  rightDiv.querySelectorAll(".hotspot-btn").forEach(b => b.remove());

  hotspots.forEach(h => {
    const btn = document.createElement("button");
    btn.className = "hotspot-btn blinking";
    btn.setAttribute("data-comp", h.name); // attributo
    btn.textContent = ""; // nessun testo

    const svgWidth = svg.clientWidth;
    const svgHeight = svg.clientHeight;
    const scaleX = svgWidth / 600;
    const scaleY = svgHeight / 2000;

    btn.style.width = h.width * scaleX + "px";
    btn.style.height = h.height * scaleY + "px";
    btn.style.left = h.x * scaleX + "px";
    btn.style.top = h.y * scaleY + "px";

    btn.addEventListener('click', () => {
      document.querySelectorAll('.checklist').forEach(c => c.style.display='none');
      const header = Array.from(document.querySelectorAll('.compartimento h3'))
                          .find(hd => hd.textContent === h.name);
      if(header){
        const checklistDiv = header.nextElementSibling;
        checklistDiv.style.display='block';
        checklistDiv.classList.remove('focus-blink');
        void checklistDiv.offsetWidth; 
        checklistDiv.classList.add('focus-blink');
        checklistDiv.scrollIntoView({behavior:'smooth', block:'center'});
      }
      document.querySelectorAll('.hotspot-btn').forEach(b=>b.classList.remove('blinking'));
      btn.classList.add('blinking');
    });

    rightDiv.appendChild(btn);
  });
}
// --- Modale foto ---
const modalFoto = document.getElementById("modalFoto");
const closeFoto = document.getElementById("closeFoto");

closeFoto.addEventListener("click", () => {
  modalFoto.style.display = "none";
});

modalFoto.addEventListener("click", (e) => {
  if(e.target === modalFoto) {
    modalFoto.style.display = "none";
  }
});

const lati = {
  "Destro": ["Anteriore Destro", "Centrale Destro", "Posteriore Destro"],
  "Sinistro": ["Anteriore Sinistro", "Centrale Sinistro", "Posteriore Sinistro"],
  "Posteriore": ["Vano Pompa"],
  "Cabina": ["Cabina"],
  "Tetto": ["Vano Pompa"]
 
};

function updateCompartmentStatus(compName){
  const compartimento = Array.from(document.querySelectorAll('.compartimento'))
    .find(div => div.querySelector("h3").textContent === compName);
  if(!compartimento) return;

  const items = compartimento.querySelectorAll(".checklist-item");
  let allCompiled = true;

  items.forEach(item => {
    if(!item.classList.contains("presente") && !item.classList.contains("assente")){
      allCompiled = false;
    }
  });

  const title = compartimento.querySelector("h3");
  const buttons = document.querySelectorAll(`.hotspot-btn[data-comp='${compName}']`);

  if(allCompiled && items.length > 0){
    title.classList.add("completed");

    buttons.forEach(btn => {
      btn.classList.add("completed");
      btn.classList.remove("blinking");
    });

    // --- CHIUDE LA TENDINA ---
    const checklistDiv = title.nextElementSibling;
    checklistDiv.style.display = 'none';
    const subcategories = compartimento.querySelectorAll(".subcategory");
    subcategories.forEach(sub => sub.classList.remove("open"));

  } else {
    title.classList.remove("completed");

    buttons.forEach(btn => btn.classList.remove("completed"));
  }

  // --- Determina lato del compartimento ---
  const lato = Object.values(lati).find(arr => arr.includes(compName));
  if(!lato) return;

  const latoCompleted = lato.every(c => {
    const div = Array.from(document.querySelectorAll('.compartimento'))
                     .find(d => d.querySelector("h3").textContent === c);
    if(!div) return false;
    const items = div.querySelectorAll(".checklist-item");
    return Array.from(items).every(i => i.classList.contains("presente") || i.classList.contains("assente"));
  });

  // Aggiorna rettangolo e testo del primo compartimento del lato
  const mainComp = lato[0];
  const mainSvgText = Array.from(document.querySelectorAll('#camionSVG text'))
    .find(t => t.textContent === mainComp);

  if(mainSvgText){
    if(latoCompleted){
      mainSvgText.previousElementSibling.setAttribute("fill", "#4CAF50"); // rettangolo verde
      mainSvgText.setAttribute("fill", "#fff"); // testo bianco
    } else {
      mainSvgText.previousElementSibling.setAttribute("fill", "#fff"); // rettangolo bianco
      mainSvgText.setAttribute("fill", "#000"); // testo nero
    }
  }
}




// --- Esporta PDF ---
function exportPDF() {
  const scelta = prompt(
    "Scegli opzione di esportazione:\n" +
    "1 = Esporta tutta la checklist\n" +
    "2 = Esporta solo il materiale mancante"
  );
  if (scelta === null) return;
  const soloAssenti = scelta === "2";

  let fileName = prompt("Inserisci il nome del file PDF:", "checklist-camion");
  if (!fileName) fileName = "checklist-camion";

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.width;
  const pageHeight = doc.internal.pageSize.height;
  let yOffset = 25;
  const lineHeight = 8;
  const leftMargin = 10;
  const bottomMargin = 12;
  const tableWidth = pageWidth - 20;
  const col1Width = tableWidth * 0.7;
  const col2Width = tableWidth * 0.3;

  const now = new Date();
  const today = now.toLocaleDateString();
  const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const checklistTitle = "Checklist Camion VVF";
  const compartimenti = document.querySelectorAll(".compartimento");

  // --- Funzione di pulizia testo ---
  function cleanText(str) {
    if (!str) return '';
    return str
      .replace(/Presente|Assente/g, '')                         
      .replace(/[%¬∂\u0000-\u001F\u007F-\u009F\u200B\u00A0]+/g, '') 
      .replace(/\s+/g, ' ')
      .trim();
  }

  function drawHeaderFooter(pageNum, totalPages) {
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text(checklistTitle, pageWidth / 2, 12, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Pagina ${pageNum} di ${totalPages}`, pageWidth - 60, pageHeight - 6);
    doc.text(`Data: ${today} ${time}`, leftMargin, pageHeight - 6);
  }

  compartimenti.forEach(div => {
    const h3 = div.querySelector("h3");
    const compartimentoTitle = cleanText(h3.textContent);

    if (yOffset + 25 > pageHeight - bottomMargin) {
      doc.addPage();
      yOffset = 25;
    }

    // Titolo compartimento centrato, grassetto e sfondo giallo
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.setFillColor(255, 255, 150); // sfondo giallo chiaro
    const textWidth = doc.getTextWidth(compartimentoTitle);
    const rectPadding = 2;
    doc.rect((pageWidth - textWidth) / 2 - rectPadding, yOffset - 6, textWidth + rectPadding * 2, lineHeight, "F");
    doc.text(compartimentoTitle, pageWidth / 2, yOffset, { align: "center" });
    yOffset += lineHeight;

    doc.setDrawColor(180);
    doc.setLineWidth(0.5);
    doc.line(leftMargin, yOffset - 3, pageWidth - leftMargin, yOffset - 3);

    const itemsDiretti = Array.from(div.querySelectorAll(".checklist-item")).filter(i => !i.closest(".subcategory"));
    const sottocategorie = div.querySelectorAll(".subcategory");

    doc.setFont("helvetica", "normal");
    let alternate = false;

    // --- Processa sottocategorie ---
    sottocategorie.forEach(sub => {
      if (yOffset + lineHeight > pageHeight - bottomMargin) {
        doc.addPage();
        yOffset = 25;
      }

      let subTitle = "";
      const h4 = sub.querySelector("h4");
      if (h4) {
        const spanStato = h4.querySelector("span");
        if (spanStato) spanStato.remove();
        subTitle = cleanText(h4.textContent);
      }

      // Intestazione sottocategoria
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.setFillColor(200, 200, 200);
      doc.rect(leftMargin, yOffset - 6, tableWidth, lineHeight, "F");
      doc.setTextColor(0);
      doc.text(subTitle, leftMargin + 2, yOffset);
      doc.text("Stato", leftMargin + col1Width + 2, yOffset);
      yOffset += lineHeight;

      // --- Items della sottocategoria ---
      const subItems = sub.querySelectorAll(".checklist-item");
      subItems.forEach(item => {
        const isPresente = item.classList.contains("presente");
        const isAssente = item.classList.contains("assente");

        if (!soloAssenti || (soloAssenti && isAssente)) {
          const label = cleanText(item.querySelector(".item-label").textContent);
          const stato = isPresente ? "‚úÖ Presente" : isAssente ? "‚ùå Assente" : "";
          const note = cleanText(item.querySelector("textarea")?.value);

          if (isAssente) doc.setFillColor(255, 230, 180);
          else if (isPresente) doc.setFillColor(200, 255, 200);
          else doc.setFillColor(alternate ? 240 : 255);
          doc.rect(leftMargin, yOffset - 6, tableWidth, lineHeight, "F");

          doc.setDrawColor(180);
          doc.rect(leftMargin, yOffset - 6, col1Width, lineHeight);
          doc.rect(leftMargin + col1Width, yOffset - 6, col2Width, lineHeight);

          doc.setTextColor(0);
          doc.text(label, leftMargin + 2, yOffset);
          doc.text(stato, leftMargin + col1Width + 2, yOffset);

          yOffset += lineHeight;
          alternate = !alternate;

          if (note) {
            const noteLines = doc.splitTextToSize("Note: " + note, tableWidth);
            noteLines.forEach(line => {
              if (yOffset + lineHeight > pageHeight - bottomMargin) {
                doc.addPage();
                yOffset = 25;
              }
              doc.setFont("helvetica", "italic");
              doc.setFontSize(11);
              doc.text(line, leftMargin + 2, yOffset);
              yOffset += lineHeight;
            });
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            yOffset += 2;
          }

          if (yOffset + lineHeight > pageHeight - bottomMargin) {
            doc.addPage();
            yOffset = 25;
          }
        }
      });

      yOffset += 3;
    });

    // --- Processa items diretti ---
    if (itemsDiretti.length) {
      if (yOffset + lineHeight > pageHeight - bottomMargin) {
        doc.addPage();
        yOffset = 25;
      }
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.setFillColor(200, 200, 200);
      doc.rect(leftMargin, yOffset - 6, tableWidth, lineHeight, "F");
      doc.setTextColor(0);
      doc.text("Oggetto", leftMargin + 2, yOffset);
      doc.text("Stato", leftMargin + col1Width + 2, yOffset);
      yOffset += lineHeight;
    }

    itemsDiretti.forEach(item => {
      const isPresente = item.classList.contains("presente");
      const isAssente = item.classList.contains("assente");

      if (!soloAssenti || (soloAssenti && isAssente)) {
        const label = cleanText(item.querySelector(".item-label").textContent);
        const stato = isPresente ? "‚úÖ Presente" : isAssente ? "‚ùå Assente" : "";
        const note = cleanText(item.querySelector("textarea")?.value);

        if (isAssente) doc.setFillColor(255, 230, 180);
        else if (isPresente) doc.setFillColor(200, 255, 200);
        else doc.setFillColor(alternate ? 240 : 255);
        doc.rect(leftMargin, yOffset - 6, tableWidth, lineHeight, "F");

        doc.setDrawColor(180);
        doc.rect(leftMargin, yOffset - 6, col1Width, lineHeight);
        doc.rect(leftMargin + col1Width, yOffset - 6, col2Width, lineHeight);

        doc.setTextColor(0);
        doc.text(label, leftMargin + 2, yOffset);
        doc.text(stato, leftMargin + col1Width + 2, yOffset);

        yOffset += lineHeight;
        alternate = !alternate;

        if (note) {
          const noteLines = doc.splitTextToSize("Note: " + note, tableWidth);
          noteLines.forEach(line => {
            if (yOffset + lineHeight > pageHeight - bottomMargin) {
              doc.addPage();
              yOffset = 25;
            }
            doc.setFont("helvetica", "italic");
            doc.setFontSize(11);
            doc.text(line, leftMargin + 2, yOffset);
            yOffset += lineHeight;
          });
          doc.setFont("helvetica", "normal");
          doc.setFontSize(12);
          yOffset += 2;
        }

        if (yOffset + lineHeight > pageHeight - bottomMargin) {
          doc.addPage();
          yOffset = 25;
        }
      }
    });

    yOffset += 5;
  });

  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    drawHeaderFooter(i, pageCount);
  }

  doc.save(fileName + ".pdf");
}
















document.getElementById("exportPDF").addEventListener("click", exportPDF);

// --- Scheda Tecnica ---
const btnScheda = document.getElementById("schedaTecnica");
const modal = document.getElementById("modalScheda");
const closeBtn = document.getElementById("closeModal");
const slideImage = document.getElementById("slideImage");
const prevSlide = document.getElementById("prevSlide");
const nextSlide = document.getElementById("nextSlide");

const immaginiCamion = [
  "https://davide1499.github.io/prova-5/camion.jpg",
  "https://davide1499.github.io/prova-5/cabina.jpg",
  "https://davide1499.github.io/prova-5/vanopompa.jpg"
];
let currentSlide = 0;

btnScheda.addEventListener("click", () => {
  modal.style.display = "flex";
  showSlide(currentSlide);
});
closeBtn.addEventListener("click", () => modal.style.display="none");
modal.addEventListener("click", e=>{if(e.target===modal) modal.style.display="none";});

function showSlide(index){
  if(index<0) index=immaginiCamion.length-1;
  if(index>=immaginiCamion.length) index=0;
  currentSlide=index;
  slideImage.src=immaginiCamion[currentSlide];
}

prevSlide.addEventListener("click", ()=>showSlide(currentSlide-1));
nextSlide.addEventListener("click", ()=>showSlide(currentSlide+1));

// --- Inizializzazione ---
  const searchInput = document.getElementById("searchInput");
const searchSuggestions = document.getElementById("searchSuggestions");

searchInput.addEventListener("input", () => {
  const val = searchInput.value.trim().toLowerCase();
  searchSuggestions.innerHTML = "";
  if (!val) { 
    searchSuggestions.style.display = "none"; 
    return; 
  }

const allItems = [];
Object.keys(camionData).forEach(comp => {
  if(Array.isArray(camionData[comp])){
    camionData[comp].forEach(item => {
      const label = typeof item === "string" ? item : item.label;
      allItems.push({label, comp});
    });
  } else {
    camionData[comp].items.forEach(item => {
      const label = typeof item === "string" ? item : item.label;
      allItems.push({label, comp});
    });
    if(camionData[comp].subcategories) {
      Object.keys(camionData[comp].subcategories).forEach(sub => {
        camionData[comp].subcategories[sub].forEach(item => {
          const label = typeof item === "string" ? item : item.label;
          allItems.push({label, comp});
        });
      });
    }
  }
});


const results = allItems
  .map(i => {
    const words = i.label.toLowerCase().split(/\s+/);
    const matchIndex = words.findIndex(word => word.startsWith(val));
    return matchIndex !== -1 ? {...i, matchWordIndex: matchIndex} : null;
  })
  .filter(i => i)
  .sort((a,b) => a.matchWordIndex - b.matchWordIndex);


  // Crea suggerimenti
  results.forEach(res => {
    const li = document.createElement("li");
    li.style.padding = "4px 6px";
    li.style.cursor = "pointer";
    li.style.whiteSpace = "nowrap";

    // Evidenzia la parte matchata solo se inizia la parola
 const words = res.label.split(/\s+/);

    const matchWord = words[res.matchWordIndex];
    words[res.matchWordIndex] = `<strong>${matchWord.substring(0, val.length)}</strong>${matchWord.substring(val.length)}`;
li.innerHTML = words.join(" ") + ` (${res.comp})`;


    li.addEventListener("click", () => {
      searchSuggestions.style.display = "none";
      searchInput.value = "";
    scrollToItem(res.label, res.comp);

    });

    searchSuggestions.appendChild(li);
  });

  searchSuggestions.style.display = results.length ? "block" : "none";
});


function scrollToItem(itemName, compName) {
  const header = Array.from(document.querySelectorAll(".compartimento h3"))
                      .find(h => h.textContent === compName);
  if(!header) return;

  // **Chiudi tutte le checklist**
  document.querySelectorAll('.checklist').forEach(c => c.style.display = 'none');

  const checklist = header.nextElementSibling;
  checklist.style.display = "block";

  const itemDiv = Array.from(checklist.querySelectorAll(".checklist-item"))
                       .find(i => i.querySelector(".item-label").textContent === itemName);

  if(itemDiv){
    // Rimuove eventuali evidenziazioni precedenti
    document.querySelectorAll(".checklist-item.focus-selected")
            .forEach(el => el.classList.remove("focus-selected"));

    // Aggiunge evidenziazione
    itemDiv.classList.add("focus-selected");

    // Scorre fino all'elemento senza cambiare lo zoom
    itemDiv.scrollIntoView({behavior: "smooth", block: "center"});

    // Rimuove evidenziazione dopo 1 secondo
    setTimeout(() => {
      itemDiv.classList.remove("focus-selected");
    }, 2000);
  }
}




createCamionUI();
createHotspotButtons();
  
  // Funzione che verifica se ci sono modifiche nella checklist
function checkForChanges() {
  const items = document.querySelectorAll(".checklist-item");
  for (let item of items) {
    const hasPresente = item.classList.contains("presente");
    const hasAssente = item.classList.contains("assente");
    const note = item.querySelector("textarea")?.value.trim();
    if (hasPresente || hasAssente || note) return true;
  }
  return false;
}

// Avviso prima di chiudere o ricaricare la pagina
window.addEventListener("beforeunload", (e) => {
  if (checkForChanges()) {
    e.preventDefault(); // Standard moderno
    e.returnValue = ""; // Chrome mostra un avviso di default
  }
});

</script>
</div>
</body>
</html>
